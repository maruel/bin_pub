#!/bin/bash
# Copyright 2025 Marc-Antoine Ruel. All Rights Reserved. Use of this
# source code is governed by a BSD-style license that can be found in the
# LICENSE file.
#
# Pull from a mydevenv container.

set -eu
cd "$(git rev-parse --show-toplevel)"

CONTAINER_NAME="cli-$(basename "$PWD")"
if [ $# -gt 1 ]; then
    echo "Usage: $0 [container_name]" >&2
    exit 1
elif [ $# -eq 1 ]; then
    CONTAINER_NAME="$1"
fi
echo "Working on $CONTAINER_NAME..."
# Make sure everything is committed inside the container.
ssh $CONTAINER_NAME "cd /app && git add .; git commit -a -q -m 'Pull from mydevenv'; true"
REMOTE_BRANCH=$(ssh $CONTAINER_NAME "cd /app && git rev-parse --abbrev-ref HEAD")
# Pull from the current remote checkout into the current branch, independent of its name.
git pull -q $CONTAINER_NAME $REMOTE_BRANCH:

if [ -f go.mod ]; then
	go test ./...
	go install . ./cmd/...
fi
